# LangChainApp æ™ºèƒ½æ—…è¡Œä»£ç†ç³»ç»Ÿ

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº **FastAPI** å’Œ **LangGraph** æ„å»ºçš„æ™ºèƒ½æ—…è¡Œä»£ç† AI åº”ç”¨ã€‚å®ƒåˆ©ç”¨ Azure OpenAI çš„æ¨ç†èƒ½åŠ›ï¼Œä¸ºç”¨æˆ·æä¾›ä»è¡Œç¨‹è§„åˆ’åˆ°é¢„è®¢çš„ä¸€ç«™å¼æœåŠ¡ã€‚

## ğŸŒŸ æ ¸å¿ƒåŠŸèƒ½åˆ—è¡¨

### 1. ğŸ§  æ™ºèƒ½æ„å›¾è¯†åˆ« (Intent Routing)
- **å¤šè½®å¯¹è¯ç®¡ç†**ï¼šèƒ½å¤Ÿç²¾å‡†è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼Œè‡ªåŠ¨è·¯ç”±åˆ°ä¸åŒçŠ¶æ€ï¼ˆå¦‚ï¼šæ›´æ–°ä¿¡æ¯ã€é—²èŠã€æŸ¥è¯¢å¤©æ°”ã€ç¡®è®¤æ–¹æ¡ˆï¼‰ã€‚
- **ä¸Šä¸‹æ–‡ç†è§£**ï¼šåŒºåˆ†â€œé—²èŠâ€ä¸â€œä¸šåŠ¡æŒ‡ä»¤â€ï¼Œåœ¨æ”¯ä»˜ç­‰å…³é”®é˜¶æ®µé”å®šä¸Šä¸‹æ–‡ï¼Œç¡®ä¿æµç¨‹å®‰å…¨ã€‚

### 2. ğŸ“‹ æ—…è¡Œéœ€æ±‚æ”¶é›† (Requirement Collection)
- **æ™ºèƒ½ä¿¡æ¯æŠ½å–**ï¼šè‡ªåŠ¨ä»è‡ªç„¶è¯­è¨€å¯¹è¯ä¸­æå– `å‡ºå‘åœ°`ã€`ç›®çš„åœ°` å’Œ `æ—¥æœŸ`ã€‚
- **æ™ºèƒ½æ ¡éªŒä¸è¡¥å…¨**ï¼š
  - **æ—¥æœŸæ ‡å‡†åŒ–**ï¼šå°†â€œä¸‹å‘¨äº”â€ã€â€œåå¤©â€ç­‰å£è¯­è½¬æ¢ä¸ºæ ‡å‡† `YYYY-MM-DD` æ ¼å¼ã€‚
  - **åœ°ç‚¹ç²¾ç¡®åŒ–**ï¼šå¼ºåˆ¶è¦æ±‚å…·ä½“åŸå¸‚åï¼ˆå¦‚â€œä¸œäº¬â€ï¼‰ï¼Œè‡ªåŠ¨è¿½é—®æ¨¡ç³Šä¿¡æ¯ã€‚

### 3. ğŸ—ºï¸ æ™ºèƒ½è¡Œç¨‹è§„åˆ’ (Travel Planning)
- **æ”»ç•¥æ£€ç´¢**ï¼šé›†æˆ **Tavily** æœç´¢å¼•æ“ï¼Œå®æ—¶è·å–ç›®çš„åœ°çš„æœ€æ–°æ—…æ¸¸æ”»ç•¥å’Œå¿…ç©æ™¯ç‚¹ã€‚
- **å¤šæ–¹æ¡ˆç”Ÿæˆ**ï¼šåŸºäºæ”»ç•¥è‡ªåŠ¨ç”Ÿæˆ 3 ä¸ªå·®å¼‚åŒ–çš„æ—…è¡Œæ–¹æ¡ˆï¼ˆç»æµå‹ã€è±ªåå‹ã€äº²å­æ¸¸ï¼‰ï¼ŒåŒ…å«ä»·æ ¼é¢„ä¼°å’Œè¯¦ç»†å®‰æ’ã€‚

### 4. âœˆï¸ æœºç¥¨æœåŠ¡ (Flight Services)
- **æ™ºèƒ½æœºåœºä»£ç è½¬æ¢**ï¼šå†…ç½®å…¨çƒæœºåœºæ•°æ®åº“ (`airportsdata`)ï¼Œæ”¯æŒä¸­æ–‡åŸå¸‚åè‡ªåŠ¨è½¬æ¢ä¸º IATA ä»£ç ã€‚
- **å®æ—¶èˆªç­æœç´¢**ï¼šé›†æˆ Google Flights (SerpApi) æœç´¢å®æ—¶èˆªç­ã€‚
- **å…¨æµç¨‹é¢„è®¢**ï¼šæ”¯æŒ `æœç´¢` -> `é€‰æ‹©` -> `é”å®šè®¢å•` -> `æ¨¡æ‹Ÿæ”¯ä»˜` çš„å®Œæ•´é—­ç¯ã€‚

### 5. ğŸ¨ é…’åº—æœåŠ¡ (Hotel Services)
- **é…’åº—æœç´¢**ï¼šæ ¹æ®ç›®çš„åœ°å’Œæ—¥æœŸæœç´¢å¯ç”¨é…’åº—èµ„æºã€‚
- **é¢„è®¢æµç¨‹**ï¼šæ”¯æŒæˆ¿æºé€‰æ‹©ã€é”å®šåŠæ¨¡æ‹Ÿæ”¯ä»˜ç¡®è®¤ã€‚

### 6. â˜€ï¸ å¤©æ°”æŸ¥è¯¢ (Weather Services)
- **å®æ—¶å¤©æ°”**ï¼šé›†æˆ OpenWeather APIï¼Œæä¾›ç›®çš„åœ°å®æ—¶å¤©æ°”æŠ¥å‘Šï¼Œè¾…åŠ©å‡ºè¡Œå†³ç­–ã€‚

### 7. ğŸ—ï¸ æŠ€æœ¯æ¶æ„ç‰¹æ€§
- **RAG å¢å¼ºæ£€ç´¢**ï¼šåŒ…å« `GraphRag` å’Œ `AgenticRag` å®ç°ï¼Œæ”¯æŒåŸºäºçŸ¥è¯†å›¾è°±çš„é«˜çº§æ£€ç´¢ã€‚
- **SSE å®æ—¶æµå¼äº¤äº’**ï¼šæ”¯æŒ Server-Sent Events åè®®ï¼Œå®ç°æ‰“å­—æœºæ•ˆæœåŠå‰ç«¯äº¤äº’ç»„ä»¶ï¼ˆå¦‚å¡ç‰‡é€‰æ‹©ï¼‰çš„å®æ—¶æ¨é€ã€‚
- **å¯è§†åŒ–è°ƒè¯•**ï¼šæä¾›æ§åˆ¶å°æµå¼è¾“å‡ºï¼Œæ¸…æ™°å±•ç¤º Agent çš„æ€è€ƒè¿‡ç¨‹ (Thinking Process) å’Œå·¥å…·è°ƒç”¨ã€‚

### 8. ğŸ“¡ SSE é€šä¿¡åè®® (API Protocol)

åç«¯é€šè¿‡ `/vibe/stream` æ¥å£æä¾› Server-Sent Events (SSE) æµå¼å“åº”ï¼Œå‰ç«¯éœ€æ ¹æ® `event` ç±»å‹è¿›è¡Œä¸åŒæ¸²æŸ“ï¼š

| Event Type | ç”¨é€” | Data Payload ç¤ºä¾‹ | å‰ç«¯å¤„ç†é€»è¾‘ |
| :--- | :--- | :--- | :--- |
| `message` | æ–‡æœ¬æ¶ˆæ¯ | `{"content": "ä½ å¥½...", "is_stream": true}` | ç»Ÿä¸€æ‰§è¡Œ**è¿½åŠ **é€»è¾‘ã€‚`is_stream` æ ‡è¯†æ˜¯å¦ä¸ºæ‰“å­—æœºå­—ç¬¦æµã€‚ |
| `control` | äº¤äº’ç»„ä»¶ | `{"type": "select_plan", "options": [...]}` | æ¸²æŸ“å¯¹åº”çš„ UI ç»„ä»¶ï¼ˆå¦‚æ–¹æ¡ˆé€‰æ‹©å¡ç‰‡ã€æœºç¥¨åˆ—è¡¨ï¼‰ã€‚ |
| `status` | çŠ¶æ€æç¤º | `{"content": "ğŸ¤” æ­£åœ¨æ€è€ƒ...", "node": "plan"}` | å±•ç¤º Loading åŠ¨ç”»æˆ–çŠ¶æ€æ æç¤ºï¼Œç¼“è§£ç­‰å¾…ç„¦è™‘ã€‚ |
| `error` | é”™è¯¯ä¿¡æ¯ | `{"message": "API è°ƒç”¨å¤±è´¥..."}` | å±•ç¤ºé”™è¯¯ Toast æˆ–è­¦å‘Šã€‚ |

**æµå¼ç­–ç•¥ (Streaming Strategy):**
- **å…¨ç¼“å†²æ¨¡å¼ (Full Buffering)**: ä¸ºç¡®ä¿å‰ç«¯å±•ç¤ºçš„ç¨³å®šæ€§ï¼Œç›®å‰æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬ `summary` å’Œ `side_chat`ï¼‰å‡é‡‡ç”¨ `on_chain_end` äº‹ä»¶è§¦å‘è¾“å‡ºã€‚
- **æ ¼å¼åŒ–è¾“å‡º**: åç«¯å·²é’ˆå¯¹ Markdown æ¸²æŸ“è¿›è¡Œäº†ä¼˜åŒ–ï¼Œç¡®ä¿æ®µè½åˆ†æ˜ (`\n\n`)ï¼Œå¹¶ä½¿ç”¨ Emoji å’Œå¡ç‰‡å¼æ’ç‰ˆå¢å¼ºå¯è¯»æ€§ã€‚

**è¯¦ç»†èŠ‚ç‚¹æµå¼é…ç½®è¡¨:**

| èŠ‚ç‚¹å | è¾“å‡ºç±»å‹ | å¤„ç†æ–¹å¼ | åŸå›  |
| :--- | :--- | :--- | :--- |
| `intent_router` | Structured (JSON) | å†…éƒ¨å¤„ç† | è·¯ç”±é€»è¾‘ï¼Œæ— éœ€å±•ç¤º |
| `collect` | Structured (JSON) | Buffered | è¾“å‡º JSONï¼Œéœ€è§£æåå±•ç¤º |
| `plan` | Structured (JSON) | Buffered | è¾“å‡ºå¤æ‚ JSON (æ–¹æ¡ˆåˆ—è¡¨)ï¼Œéœ€è§£æ |
| `search_flight` | Tool + Text | Buffered | è¾“å‡ºåŒ…å« API æ•°æ®ï¼Œéœ€è§£æ |
| `select_flight` | Structured (JSON) | Buffered | å†…éƒ¨å†³ç­–é€»è¾‘ï¼Œè¾“å‡ºç¡®è®¤æ–‡æœ¬ |
| `pay_flight` | Tool + Text | Buffered | æ”¯ä»˜ç»“æœï¼ŒçŸ­æ–‡æœ¬ |
| `search_hotel` | Tool + Text | Buffered | åŒæœºç¥¨æœç´¢ |
| `select_hotel` | Structured (JSON) | Buffered | åŒæœºç¥¨é€‰æ‹© |
| `pay_hotel` | Tool + Text | Buffered | åŒæœºç¥¨æ”¯ä»˜ |
| `summary` | Pure Text | Buffered | ç¡®ä¿å®Œæ•´ç”Ÿæˆåå†å‘é€ï¼Œé¿å…æ–­æµ |
| `check_weather` | Structured (JSON) | Buffered | å†…éƒ¨å…ˆæå– JSON å†è°ƒç”¨å·¥å…· |
| `side_chat` | Pure Text | Buffered | ç¡®ä¿å®Œæ•´ç”Ÿæˆåå†å‘é€ |
| `guide` | Structured (JSON) | Buffered | è¾“å‡º JSONï¼Œä¸èƒ½æµå¼ï¼ |

### 9. ğŸ§© æ ¸å¿ƒèŠ‚ç‚¹è¯´æ˜ (Graph Nodes)

LangGraph çŠ¶æ€æœºåŒ…å«ä»¥ä¸‹æ ¸å¿ƒèŠ‚ç‚¹ï¼Œè´Ÿè´£ä¸åŒçš„ä¸šåŠ¡é€»è¾‘ï¼š

| èŠ‚ç‚¹ ID | åŠŸèƒ½æè¿° | è¾“å‡ºç±»å‹ |
| :--- | :--- | :--- |
| `intent_router` | **æ„å›¾è·¯ç”±**ã€‚åˆ†æç”¨æˆ·è¾“å…¥ï¼Œå†³å®šä¸‹ä¸€æ­¥æ˜¯æ”¶é›†ä¿¡æ¯ã€é—²èŠè¿˜æ˜¯æ‰§è¡Œç‰¹å®šä»»åŠ¡ã€‚ | å†…éƒ¨çŠ¶æ€ (State Update) |
| `collect` | **ä¿¡æ¯æ”¶é›†**ã€‚è´Ÿè´£å¤šè½®å¯¹è¯ä»¥è·å–å®Œæ•´çš„å‡ºå‘åœ°ã€ç›®çš„åœ°å’Œæ—¥æœŸã€‚ | JSON (Structured) |
| `plan` | **æ–¹æ¡ˆç”Ÿæˆ**ã€‚è°ƒç”¨æœç´¢å·¥å…·è·å–æ”»ç•¥ï¼Œå¹¶ç”Ÿæˆ 3 ä¸ªæ¨èæ–¹æ¡ˆã€‚ | JSON + Control Event |
| `search_flight` | **æœºç¥¨æœç´¢**ã€‚å°†åŸå¸‚åè½¬ä¸ºæœºåœºä»£ç ï¼Œè°ƒç”¨ API æœç´¢å®æ—¶èˆªç­ã€‚ | JSON + Control Event |
| `select_flight` | **æœºç¥¨é”å®š**ã€‚å¤„ç†ç”¨æˆ·çš„é€‰æ‹©æŒ‡ä»¤ (å¦‚ "F1")ï¼Œé”å®šç‰¹å®šèˆªç­ã€‚ | Text |
| `pay_flight` | **æœºç¥¨æ”¯ä»˜**ã€‚æ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹ï¼Œç”Ÿæˆè®¢å•å·ã€‚ | Text |
| `search_hotel` | **é…’åº—æœç´¢**ã€‚æœç´¢ç›®çš„åœ°é…’åº—èµ„æºã€‚ | JSON + Control Event |
| `select_hotel` | **é…’åº—é”å®š**ã€‚å¤„ç†ç”¨æˆ·çš„é€‰æ‹©æŒ‡ä»¤ (å¦‚ "H1")ï¼Œé”å®šç‰¹å®šé…’åº—ã€‚ | Text |
| `pay_hotel` | **é…’åº—æ”¯ä»˜**ã€‚æ¨¡æ‹Ÿæ”¯ä»˜æµç¨‹ï¼Œç”Ÿæˆè®¢å•å·ã€‚ | Text |
| `summary` | **è¡Œç¨‹æ€»ç»“**ã€‚æ±‡æ€»æ‰€æœ‰é¢„è®¢ä¿¡æ¯ï¼Œç”Ÿæˆæœ€ç»ˆçš„ Markdown è¡Œç¨‹å•ã€‚ | Stream Text |
| `check_weather` | **å¤©æ°”æŸ¥è¯¢**ã€‚æå–åœ°ç‚¹å¹¶è°ƒç”¨å¤©æ°” APIã€‚ | Text |
| `side_chat` | **æ™ºèƒ½é—²èŠ**ã€‚å¤„ç†éä¸šåŠ¡æŒ‡ä»¤ï¼Œæä¾›äººæ€§åŒ–çš„å¯¹è¯äº’åŠ¨ã€‚ | Stream Text |
| `guide` | **æµç¨‹å¼•å¯¼**ã€‚åœ¨æ¯ä¸ªæ­¥éª¤ç»“æŸåï¼Œç”Ÿæˆç®€çŸ­çš„ä¸‹ä¸€æ­¥æ“ä½œæç¤ºã€‚ | Text (Buffered) |

## ğŸš€ å¼€å‘æŒ‡å— (Developer Guide)

### ğŸ—ï¸ æ¶æ„æ¦‚è¿° (Architecture Overview)

- **æ¡†æ¶**: FastAPI (`app/main.py`) é€šè¿‡ Uvicorn æä¾›æœåŠ¡ã€‚
- **ä»£ç†å¼•æ“**: LangGraph (`app/infras/agent/travel_agent.py`) ç®¡ç†çŠ¶æ€å’Œæµç¨‹ã€‚
- **ç›®å½•ç»“æ„**:
  - `app/infras/agent/`: æ ¸å¿ƒä»£ç†é€»è¾‘ã€å›¾å®šä¹‰å’Œè¿è¡Œå™¨ã€‚
  - `app/infras/func/`: ä»£ç†å·¥å…·å’Œå‡½æ•°ï¼ˆä»£ç†çš„â€œæŠ€èƒ½â€ï¼‰ã€‚
  - `app/infras/third_api/`: å¤–éƒ¨ API åŒ…è£…å™¨ï¼ˆAmadeusã€OpenWeatherã€Tavilyï¼‰ã€‚
  - `app/infras/rag/`: RAG å®ç°ï¼ˆGraphRAGã€AgenticRAGï¼‰ã€‚
  - `app/router/`: FastAPI è·¯ç”±å¤„ç†å™¨ã€‚
  - `tests/`: Pytest æµ‹è¯•å¥—ä»¶ã€‚

### ğŸš€ å¼€å‘å·¥ä½œæµç¨‹ (Development Workflow)

- **è¿è¡ŒæœåŠ¡å™¨**: æ‰§è¡Œ `python start.py`ã€‚è¿™å°†åœ¨ `http://localhost:8000` å¯åŠ¨ APIã€‚
  - API æ–‡æ¡£: `http://localhost:8000/scalar/v1` æˆ– `/docs`ã€‚
- **è¿è¡Œæµ‹è¯•**: ä½¿ç”¨ `pytest`ã€‚é…ç½®åœ¨ `pyproject.toml` ä¸­ã€‚
- **ä¾èµ–ç®¡ç†**: ä¾èµ–é¡¹åˆ—åœ¨ `pyproject.toml` ä¸­ã€‚

### ğŸ§© ä»£ç†å¼€å‘æ¨¡å¼ (Agent Development Patterns)

#### 1. å®šä¹‰ä»£ç† (LangGraph)
- ä»£ç†åœ¨ `app/infras/agent/travel_agent.py` ä¸­å®šä¹‰ä¸º `StateGraph`ã€‚
- ä½¿ç”¨ `TypedDict` æˆ– Pydantic æ¨¡å‹ä½œä¸ºå›¾çŠ¶æ€ã€‚
- **æµå¼**: é¡¹ç›®ä½¿ç”¨ `app/infras/agent/agent_runner.py` ä¸­çš„è‡ªå®šä¹‰ SSE (Server-Sent Events) å®ç°ã€‚
  - `sse_chat_stream`: å¤„ç†å‰ç«¯çš„åè®®é€‚é…ã€‚
  - `run_chat_stream`: æ§åˆ¶å°æµå¼è°ƒè¯•ã€‚

#### 2. æ·»åŠ å·¥å…·
1. **å®ç°é€»è¾‘**: åœ¨ `app/infras/func/` ä¸­åˆ›å»ºå‡½æ•°ã€‚
2. **å¤–éƒ¨è°ƒç”¨**: å¦‚æœè°ƒç”¨å¤–éƒ¨ APIï¼Œå°†ä½çº§åŒ…è£…å™¨æ”¾åœ¨ `app/infras/third_api/` ä¸­ã€‚
3. **æ³¨å†Œ**: åœ¨ `app/infras/agent/travel_agent.py` ä¸­å¯¼å…¥å¹¶æ·»åŠ åˆ°ä»£ç†çš„å·¥å…·èŠ‚ç‚¹ã€‚

#### 3. RAG é›†æˆ
- RAG ç»„ä»¶ä½äº `app/infras/rag/`ã€‚
- `GraphRag.py` å’Œ `AgenticRag.py` å»ºè®®é«˜çº§æ£€ç´¢ç­–ç•¥ã€‚

### ğŸ“ ç¼–ç çº¦å®š (Coding Conventions)

- **Async/Await**: ä»£ç åº“å¤§é‡ä½¿ç”¨å¼‚æ­¥ï¼ˆFastAPI + LangChain å¼‚æ­¥æ–¹æ³•ï¼‰ã€‚è·¯ç”±å¤„ç†å™¨å’Œä»£ç†èŠ‚ç‚¹å§‹ç»ˆä½¿ç”¨ `async def`ã€‚
- **ç±»å‹æç¤º**: å¹¿æ³›ä½¿ç”¨ Python ç±»å‹æç¤ºã€‚
- **é…ç½®**: é€šè¿‡ `python-dotenv` åŠ è½½ç¯å¢ƒå˜é‡ã€‚ç¡®ä¿ `.env` æ–‡ä»¶å­˜åœ¨ï¼ˆè§ `app/infras/agent/travel_agent.py` ä¸­çš„å¯†é’¥ï¼Œå¦‚ `AZURE_OPENAI_API_KEY`ï¼‰ã€‚
- **é”™è¯¯å¤„ç†**: ä»£ç†è¿è¡Œå™¨åº”æ•è·å¼‚å¸¸ï¼Œä»¥é˜²æ­¢æµå¼æœŸé—´æœåŠ¡å™¨å´©æºƒã€‚

### ğŸ” å…³é”®æ–‡ä»¶ (Key Files)
- `start.py`: å¼€å‘æœåŠ¡å™¨å…¥å£ç‚¹ã€‚
- `app/infras/agent/travel_agent.py`: ä¸»ä»£ç†å›¾å®šä¹‰ã€‚
- `app/infras/agent/agent_runner.py`: æµå¼é€»è¾‘ï¼ˆSSE å’Œæ§åˆ¶å°ï¼‰ã€‚
- `app/router/agent_router.py`: å¤„ç†ä»£ç†è¯·æ±‚çš„ç«¯ç‚¹ã€‚
